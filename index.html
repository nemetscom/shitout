<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHITOUT — Dust Cleaner & Governance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            transition: all 0.2s ease;
        }
        .btn-primary:active { transform: scale(0.98); }
        .pulse-energy { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="text-2xl font-bold">S</span>
            </div>
            <h1 class="text-3xl font-bold tracking-tighter text-blue-500">SHITOUT</h1>
        </div>

        <div class="flex items-center gap-4 flex-wrap justify-center">
            <div id="energy-display" class="hidden glass px-4 py-2 rounded-xl flex items-center gap-3">
                <span class="text-yellow-400 pulse-energy">⚡</span>
                <span class="text-sm">Energy: <span id="energy-val">0</span> / <span id="max-energy-val">0</span></span>
            </div>
            <button id="connect-btn" onclick="connectWallet()" class="btn-primary px-6 py-2 rounded-xl font-bold text-sm">
                Connect Wallet
            </button>
        </div>
    </header>

    <nav class="max-w-4xl mx-auto flex justify-around border-b border-slate-700 mb-8">
        <button onclick="switchTab('clean')" id="tab-btn-clean" class="tab-active py-4 px-6 font-bold uppercase text-xs">Clean</button>
        <button onclick="switchTab('gov')" id="tab-btn-gov" class="py-4 px-6 font-bold uppercase text-xs">Governance</button>
        <button onclick="switchTab('buy')" id="tab-btn-buy" class="py-4 px-6 font-bold uppercase text-xs">Buy $SHITOUT</button>
    </nav>

    <main class="max-w-6xl mx-auto">
        
        <section id="tab-clean" class="tab-content">
            <div id="wallet-placeholder" class="text-center py-20 glass rounded-3xl border-dashed border-2 border-slate-700">
                <p class="text-slate-400">Connect wallet to scan Base network for dust.</p>
                <button onclick="connectWallet()" class="mt-4 text-blue-500 underline text-sm">Click to connect</button>
            </div>
            <div id="clean-dashboard" class="hidden space-y-8">
                <div id="section-approved">
                    <h2 class="text-xl font-bold mb-4 text-blue-400">Ready to Clean</h2>
                    <div id="approved-list" class="grid gap-4 text-center p-8 glass rounded-xl text-slate-500 italic">
                        Scanning your wallet...
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-gov" class="tab-content hidden">
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="space-y-6">
                    <div class="glass p-6 rounded-2xl">
                        <h3 class="font-bold mb-4">New Proposal</h3>
                        <input id="token-address-input" type="text" placeholder="Token Address (0x...)" 
                               class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm mb-4 outline-none focus:border-blue-500">
                        <button onclick="proposeNewToken()" class="w-full btn-primary py-3 rounded-lg font-bold">
                            Propose (0.001 $SHITOUT)
                        </button>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-4" id="active-proposals">
                    <p class="text-center text-slate-500 py-10 italic">Loading active proposals from Supabase...</p>
                </div>
            </div>
        </section>

        <section id="tab-buy" class="tab-content hidden">
            <div class="max-w-2xl mx-auto glass-card p-8 rounded-3xl text-center">
                <h2 class="text-2xl font-bold mb-6 text-blue-400">Get Energy</h2>
                <div id="shitout-price" class="text-xl mb-6 font-bold">Price: $---</div>
                <a href="https://app.uniswap.org/#/swap?chain=base&outputCurrency=0xf37E99001AE478077B184bf448FE8174d928e5a4" target="_blank" 
                   class="btn-primary inline-block w-full py-4 rounded-2xl font-bold text-lg mb-4">
                    Buy $SHITOUT on Uniswap
                </a>
                <div class="flex items-center justify-center gap-2">
                    <span class="text-[10px] text-slate-500">0xf37E99001AE478077B184bf448FE8174d928e5a4</span>
                    <button onclick="copyContract()" class="text-blue-500 text-xs">Copy</button>
                </div>
            </div>
        </section>
    </main>

    <div id="toast-container" class="fixed bottom-8 right-8 z-50 flex flex-col gap-2"></div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = "https://mfqteusxmwaagebykcdw.supabase.co";
        const SUPABASE_KEY = "YOUR_SUPABASE_KEY"; // ОБЯЗАТЕЛЬНО ВСТАВЬ КЛЮЧ
        const SHITOUT_ADDR = "0xf37E99001AE478077B184bf448FE8174d928e5a4";
        const BASE_ID = "0x2105"; // 8453

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let provider, signer, userAddr, energy = 0, balance = 0;

        // --- NAVIGATION ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('tab-btn-' + id).classList.add('tab-active');
            if(id === 'gov') loadProposals();
            if(id === 'buy') fetchShitoutPrice();
        }

        // --- CORE WALLET CONNECTION ---
        async function connectWallet() {
            if (!window.ethereum) {
                showToast("Please install MetaMask!", "error");
                return;
            }

            try {
                // 1. Форсируем вызов окна MetaMask
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddr = accounts[0];

                // 2. Инициализируем ethers
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                // 3. Проверка сети Base
                const network = await provider.getNetwork();
                if (network.chainId !== 8453n) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_ID }],
                        });
                    } catch (switchError) {
                        // Если сеть не добавлена
                        if (switchError.code === 4902) {
                            showToast("Please add Base network to your wallet", "error");
                        }
                    }
                }

                showToast("Connected Successfully", "success");
                await refreshUserData();
                updateUI();

            } catch (error) {
                console.error(error);
                showToast("Connection rejected", "error");
            }
        }

        // Слушатель смены аккаунтов
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    userAddr = accounts[0];
                    refreshUserData().then(updateUI);
                } else {
                    userAddr = null;
                    updateUI();
                }
            });

            window.ethereum.on('chainChanged', () => window.location.reload());
        }

        async function refreshUserData() {
            if (!userAddr || !provider) return;
            try {
                const abi = ["function balanceOf(address) view returns (uint256)"];
                const contract = new ethers.Contract(SHITOUT_ADDR, abi, provider);
                const b = await contract.balanceOf(userAddr);
                balance = parseFloat(ethers.formatEther(b));

                const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                const { data: votes } = await sb.from('votes_log').select('amount').eq('user_address', userAddr).gte('created_at', sevenDaysAgo);
                const spent = votes ? votes.reduce((sum, v) => sum + parseFloat(v.amount), 0) : 0;
                
                energy = Math.max(0, balance - spent);
            } catch (e) {
                console.error("Data refresh error:", e);
            }
        }

        function updateUI() {
            const btn = document.getElementById('connect-btn');
            const enDisp = document.getElementById('energy-display');
            
            if (userAddr) {
                btn.innerText = `${userAddr.slice(0,6)}...${userAddr.slice(-4)}`;
                btn.classList.replace('btn-primary', 'glass');
                enDisp.classList.remove('hidden');
                document.getElementById('energy-val').innerText = Math.floor(energy).toLocaleString();
                document.getElementById('max-energy-val').innerText = Math.floor(balance).toLocaleString();
                document.getElementById('wallet-placeholder').classList.add('hidden');
                document.getElementById('clean-dashboard').classList.remove('hidden');
            } else {
                btn.innerText = "Connect Wallet";
                btn.classList.replace('glass', 'btn-primary');
                enDisp.classList.add('hidden');
                document.getElementById('wallet-placeholder').classList.remove('hidden');
                document.getElementById('clean-dashboard').classList.add('hidden');
            }
        }

        // --- GOVERNANCE ---
        async function loadProposals() {
            const container = document.getElementById('active-proposals');
            const { data: tokens, error } = await sb.from('governance_tokens').select('*').order('total_votes', { ascending: false });
            
            if (error || !tokens || tokens.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-10">No tokens found in database</p>`;
                return;
            }

            container.innerHTML = tokens.map(t => `
                <div class="glass-card p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="font-bold text-blue-400">${t.symbol}</div>
                        <div class="text-[10px] text-slate-500">${t.token_address}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-sm">${Number(t.total_votes).toLocaleString()}</span>
                        <div class="flex gap-1">
                            <button onclick="vote('${t.id}', 'up')" class="px-3 py-1 bg-blue-500/20 text-blue-400 rounded-md text-xs hover:bg-blue-500/40">UP</button>
                            <button onclick="vote('${t.id}', 'down')" class="px-3 py-1 bg-slate-700 text-slate-300 rounded-md text-xs hover:bg-slate-600">DWN</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- HELPERS ---
        function showToast(m, type) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `glass p-4 rounded-xl border-l-4 ${type === 'error' ? 'border-red-500' : 'border-blue-500'} animate-bounce-in shadow-2xl`;
            t.innerHTML = `<span class="text-sm font-bold">${m}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        async function fetchShitoutPrice() {
            try {
                const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${SHITOUT_ADDR}`);
                const data = await res.json();
                if (data.pairs) {
                    document.getElementById('shitout-price').innerText = `Price: $${parseFloat(data.pairs[0].priceUsd).toFixed(6)}`;
                }
            } catch (e) {}
        }

        function copyContract() {
            navigator.clipboard.writeText(SHITOUT_ADDR);
            showToast("Contract Copied!", "success");
        }

        updateUI();
    </script>
</body>
</html>
