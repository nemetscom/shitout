<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHITOUT v1.0.1 — Dust Cleaner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; background: radial-gradient(circle at top right, #1e293b, #0f172a); color: #f1f5f9; min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(59, 130, 246, 0.2); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); transition: all 0.2s ease; }
        .version-tag { position: fixed; bottom: 10px; left: 10px; font-size: 10px; color: #475569; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="version-tag">v1.0.1 | Base Network</div>

    <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="text-2xl font-bold">S</span>
            </div>
            <h1 class="text-3xl font-bold tracking-tighter text-blue-500">SHITOUT</h1>
        </div>

        <div class="flex items-center gap-4 flex-wrap justify-center">
            <div id="energy-display" class="hidden glass px-4 py-2 rounded-xl flex items-center gap-3 border-blue-500/30">
                <span class="text-yellow-400">⚡</span>
                <span class="text-sm">Energy: <span id="energy-val">0</span> / <span id="max-energy-val">0</span></span>
            </div>
            <button id="connect-btn" onclick="connectWallet()" class="btn-primary px-6 py-2 rounded-xl font-bold text-sm">
                Connect Wallet
            </button>
        </div>
    </header>

    <nav class="max-w-4xl mx-auto flex justify-around border-b border-slate-700 mb-8">
        <button onclick="switchTab('clean')" id="tab-btn-clean" class="tab-active py-4 px-6 font-bold uppercase text-xs">Clean</button>
        <button onclick="switchTab('gov')" id="tab-btn-gov" class="py-4 px-6 font-bold uppercase text-xs">Governance</button>
        <button onclick="switchTab('buy')" id="tab-btn-buy" class="py-4 px-6 font-bold uppercase text-xs">Buy</button>
    </nav>

    <main class="max-w-6xl mx-auto">
        <section id="tab-clean" class="tab-content">
            <div id="wallet-placeholder" class="text-center py-20 glass rounded-3xl border-dashed border-2 border-slate-700">
                <p class="text-slate-400">Connect wallet to scan for dust.</p>
            </div>

            <div id="clean-dashboard" class="hidden space-y-8">
                <div class="flex justify-between items-center bg-blue-500/10 p-4 rounded-xl border border-blue-500/20">
                    <span class="text-sm font-bold">Scanner Status:</span>
                    <span id="scan-status" class="text-xs text-blue-400 italic font-bold">Idle</span>
                </div>

                <div id="approved-section">
                    <h2 class="text-xl font-bold mb-4 text-blue-400 flex items-center gap-2">Ready to Clean</h2>
                    <div id="approved-list" class="grid gap-4"></div>
                </div>

                <div id="unknown-section">
                    <h2 class="text-xl font-bold mb-4 text-slate-500">Other Tokens</h2>
                    <div id="unknown-list" class="grid gap-4"></div>
                </div>
            </div>
        </section>

        <section id="tab-gov" class="tab-content hidden py-20 text-center">
            <p class="text-slate-500 italic">Governance v1.0.1 - Waiting for scan logic finish...</p>
        </section>
        <section id="tab-buy" class="tab-content hidden py-20 text-center text-slate-500">
            <p>Buy Section - v1.0.1</p>
        </section>
    </main>

    <div id="toast-container" class="fixed bottom-8 right-8 z-50 flex flex-col gap-2"></div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = "https://mfqteusxmwaagebykcdw.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mcXRldXN4bXdhYWdlYnlrY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODIyNDUsImV4cCI6MjA4NjE1ODI0NX0.x5NttkdL64UNu9toj-ud02Y0J_DYBojp--4FzTo9ULI";
        const SHITOUT_ADDR = "0xf37E99001AE478077B184bf448FE8174d928e5a4";
        const BASE_ID = "0x2105";

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let provider, signer, userAddr, balance = 0;

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"
        ];

        // --- CORE FUNCTIONS ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('tab-btn-' + id).classList.add('tab-active');
        }

        async function connectWallet() {
            if (!window.ethereum) return showToast("Install MetaMask", "error");
            try {
                console.log("v1.0.1: Initiating connection...");
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddr = accounts[0];
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                
                showToast("Connected: " + userAddr.slice(0,6), "success");
                updateUI();
                await scanUserDust(); 
            } catch (e) {
                console.error("v1.0.1 Connection Error:", e);
                showToast("Connection Failed", "error");
            }
        }

        async function scanUserDust() {
            const approvedDiv = document.getElementById('approved-list');
            const unknownDiv = document.getElementById('unknown-list');
            const statusLabel = document.getElementById('scan-status');

            statusLabel.innerText = "Fetching list from Supabase...";
            approvedDiv.innerHTML = "";
            unknownDiv.innerHTML = "";

            try {
                // 1. Тянем токены из базы
                const { data: dbTokens, error } = await sb.from('governance_tokens').select('*');
                
                if (error) {
                    console.error("Supabase Error:", error);
                    statusLabel.innerText = "DB Error";
                    return;
                }

                if (!dbTokens || dbTokens.length === 0) {
                    statusLabel.innerText = "Database is empty";
                    approvedDiv.innerHTML = "<p class='text-slate-500 italic p-4 text-center'>No tokens registered in governance yet.</p>";
                    return;
                }

                statusLabel.innerText = `Scanning ${dbTokens.length} tokens...`;

                for (let i = 0; i < dbTokens.length; i++) {
                    const token = dbTokens[i];
                    statusLabel.innerText = `Checking ${i+1}/${dbTokens.length}: ${token.symbol}`;
                    
                    try {
                        const contract = new ethers.Contract(token.token_address, ERC20_ABI, provider);
                        const bRaw = await contract.balanceOf(userAddr);
                        const dec = await contract.decimals();
                        const bFormatted = parseFloat(ethers.formatUnits(bRaw, dec));

                        if (bFormatted > 0) {
                            const card = createCard(token, bFormatted);
                            if (token.status === 'approved') approvedDiv.innerHTML += card;
                            else unknownDiv.innerHTML += card;
                        }
                    } catch (tokenErr) {
                        console.warn("Skip token:", token.symbol, tokenErr.message);
                    }
                }
                statusLabel.innerText = "Scan Complete";
                if (approvedDiv.innerHTML === "") approvedDiv.innerHTML = "<p class='text-slate-500 p-4'>No approved dust found.</p>";

            } catch (err) {
                console.error("Global Scan Error:", err);
                statusLabel.innerText = "Scan Failed";
            }
        }

        function createCard(token, balance) {
            return `
                <div class="glass-card p-4 rounded-xl flex justify-between items-center border-l-4 ${token.status === 'approved' ? 'border-blue-500' : 'border-slate-600'}">
                    <div>
                        <div class="font-bold text-blue-400">${token.symbol}</div>
                        <div class="text-[10px] text-slate-500">${token.token_address.slice(0,20)}...</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold">${balance.toLocaleString()}</div>
                        <div class="text-[10px] uppercase text-slate-500">${token.status}</div>
                    </div>
                </div>
            `;
        }

        function updateUI() {
            document.getElementById('connect-btn').innerText = userAddr ? userAddr.slice(0,8) + "..." : "Connect Wallet";
            document.getElementById('wallet-placeholder').classList.toggle('hidden', !!userAddr);
            document.getElementById('clean-dashboard').classList.toggle('hidden', !userAddr);
        }

        function showToast(m, type) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `glass p-4 rounded-xl border-l-4 ${type === 'error' ? 'border-red-500' : 'border-blue-500'} shadow-2xl`;
            t.innerHTML = `<span class="text-sm font-bold">${m}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        updateUI();
    </script>
</body>
</html>
