<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHITOUT — Dust Cleaner & Governance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: #f1f5f9;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
        }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        /* Анимация пульсации для энергии */
        .pulse-energy {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Кастомный скроллбар */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="text-2xl font-bold">S</span>
            </div>
            <h1 class="text-3xl font-bold tracking-tighter text-blue-500">SHITOUT</h1>
        </div>

        <div class="flex items-center gap-4 flex-wrap justify-center">
            <div id="energy-display" class="hidden glass px-4 py-2 rounded-xl flex items-center gap-3 border-blue-500/30">
                <span class="text-yellow-400 pulse-energy">⚡</span>
                <span class="text-sm">Energy: <span id="energy-val" class="font-bold">0</span> / <span id="max-energy-val">0</span></span>
            </div>
            
            <button id="connect-btn" onclick="toggleWallet()" class="btn-primary px-6 py-2 rounded-xl font-bold text-sm">
                Connect Wallet
            </button>
        </div>
    </header>

    <nav class="max-w-4xl mx-auto flex justify-around border-b border-slate-700 mb-8">
        <button onclick="switchTab('clean')" id="tab-btn-clean" class="tab-active py-4 px-6 font-bold uppercase tracking-widest text-xs transition-all">Clean</button>
        <button onclick="switchTab('gov')" id="tab-btn-gov" class="py-4 px-6 font-bold uppercase tracking-widest text-xs transition-all">Governance</button>
        <button onclick="switchTab('buy')" id="tab-btn-buy" class="py-4 px-6 font-bold uppercase tracking-widest text-xs transition-all">Buy $SHITOUT</button>
    </nav>

    <main class="max-w-6xl mx-auto">
        
        <section id="tab-clean" class="tab-content">
            <div id="wallet-placeholder" class="text-center py-20 glass rounded-3xl border-dashed border-2 border-slate-700">
                <p class="text-slate-400 mb-4">Please connect your wallet to scan for dust tokens on Base network.</p>
            </div>
            
            <div id="clean-dashboard" class="hidden space-y-8">
                <div>
                    <h2 class="text-xl font-bold mb-4 text-blue-400 flex items-center gap-2">
                        <span>✓</span> Ready to Clean
                    </h2>
                    <div id="approved-list" class="grid gap-4">
                        </div>
                    <button class="mt-6 w-full py-4 rounded-2xl bg-green-600/20 border border-green-500/30 text-green-400 font-bold hover:bg-green-600/30 transition-all uppercase tracking-widest">
                        Batch Swap Selected to USDC
                    </button>
                </div>

                <div>
                    <h2 class="text-xl font-bold mb-4 text-slate-400 flex items-center gap-2">
                        <span>?</span> Unidentified Assets
                    </h2>
                    <div id="unknown-list" class="grid gap-4">
                        </div>
                </div>
            </div>
        </section>

        <section id="tab-gov" class="tab-content hidden">
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="space-y-6">
                    <div class="glass p-6 rounded-2xl">
                        <h3 class="font-bold mb-4 flex items-center gap-2">New Proposal</h3>
                        <div class="space-y-4">
                            <input id="token-address-input" type="text" placeholder="Token Contract Address" 
                                   class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none">
                            <button onclick="proposeToken()" class="w-full btn-primary py-3 rounded-lg font-bold">
                                Propose (0.001 $SHITOUT)
                            </button>
                        </div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-yellow-500/20">
                        <h3 class="text-yellow-400 font-bold mb-2">Voting Rules</h3>
                        <ul class="text-xs text-slate-400 space-y-2">
                            <li>• Max duration: 7 days</li>
                            <li>• 1 hour silence closes proposal</li>
                            <li>• Target: 10,000,000 total votes</li>
                            <li>• Your cap: 100,000 per token</li>
                        </ul>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-4" id="active-proposals">
                    </div>
            </div>
        </section>

        <section id="tab-buy" class="tab-content hidden">
            <div class="max-w-2xl mx-auto space-y-8">
                <div class="glass-card p-8 rounded-3xl text-center">
                    <h2 class="text-2xl font-bold mb-2 text-blue-400">Fuel Your Energy</h2>
                    <div class="text-4xl font-bold mb-6">$SHITOUT</div>
                    <p class="text-slate-400 mb-8 leading-relaxed">
                        To influence the cleaning process and vote for new tokens, you need $SHITOUT. 
                        Holding tokens generates **Energy Reserve** based on a 7-day rolling window.
                    </p>
                    <div class="flex flex-col gap-4">
                        <a href="https://app.uniswap.org/#/swap?chain=base&outputCurrency=0xf37E99001AE478077B184bf448FE8174d928e5a4" target="_blank" 
                           class="btn-primary py-4 rounded-2xl font-bold text-lg shadow-xl shadow-blue-500/20">
                            Buy on Uniswap
                        </a>
                        <button onclick="copyContract()" class="text-xs text-slate-500 hover:text-slate-300">
                            Copy Contract: 0xf37E...e5a4
                        </button>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4 text-center">
                    <div class="glass p-6 rounded-2xl">
                        <div class="text-blue-500 font-bold mb-2">1 $SHITOUT</div>
                        <div class="text-xs text-slate-400 uppercase">1 Voting Power</div>
                    </div>
                    <div class="glass p-6 rounded-2xl">
                        <div class="text-blue-500 font-bold mb-2">7 Days</div>
                        <div class="text-xs text-slate-400 uppercase">Energy Recovery</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="toast-container" class="fixed bottom-8 right-8 z-50 flex flex-col gap-2"></div>

    <script>
        // CONFIGURATION
        const SUPABASE_URL = "https://mfqteusxmwaagebykcdw.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mcXRldXN4bXdhYWdlYnlrY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODIyNDUsImV4cCI6MjA4NjE1ODI0NX0.x5NttkdL64UNu9toj-ud02Y0J_DYBojp--4FzTo9ULI"; // ВСТАВЬ СВОЙ КЛЮЧ
        const SHITOUT_ADDRESS = "0xf37E99001AE478077B184bf448FE8174d928e5a4";
        const BASE_CHAIN_ID = "0x2105";

        // STATE
        let provider, signer, userAddress;
        let userBalance = 0;
        let availableEnergy = 0;

        // Initialize Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // UI Logic
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));
            
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabId}`).classList.add('tab-active');
        }

        async function toggleWallet() {
            if (userAddress) {
                // Disconnect logic
                userAddress = null;
                updateUI();
                return;
            }

            if (window.ethereum) {
                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    const network = await provider.getNetwork();
                    
                    if (network.chainId !== 8453n) { // Base Mainnet ID
                        showToast("Please switch to Base network", "error");
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_CHAIN_ID }],
                        });
                    }

                    await provider.send("eth_requestAccounts", []);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    showToast("Connected: " + userAddress.slice(0,6) + "...", "success");
                    await fetchUserData();
                    updateUI();
                } catch (err) {
                    showToast("Connection failed", "error");
                }
            } else {
                showToast("Metamask not found", "error");
            }
        }

        async function fetchUserData() {
            // 1. Fetch $SHITOUT Balance
            const abi = ["function balanceOf(address) view returns (uint256)"];
            const contract = new ethers.Contract(SHITOUT_ADDRESS, abi, provider);
            const bal = await contract.balanceOf(userAddress);
            userBalance = parseFloat(ethers.formatEther(bal));

            // 2. Fetch Votes log from Supabase to calculate energy
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const { data: votes, error } = await supabase
                .from('votes_log')
                .select('amount')
                .eq('user_address', userAddress)
                .gte('created_at', sevenDaysAgo.toISOString());

            let usedEnergy = 0;
            if (votes) {
                usedEnergy = votes.reduce((acc, v) => acc + parseFloat(v.amount), 0);
            }

            availableEnergy = Math.max(0, userBalance - usedEnergy);
        }

        function updateUI() {
            const btn = document.getElementById('connect-btn');
            const energyDisplay = document.getElementById('energy-display');
            const cleanPlaceholder = document.getElementById('wallet-placeholder');
            const cleanDashboard = document.getElementById('clean-dashboard');

            if (userAddress) {
                btn.innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
                btn.classList.replace('btn-primary', 'glass');
                energyDisplay.classList.remove('hidden');
                document.getElementById('energy-val').innerText = Math.floor(availableEnergy).toLocaleString();
                document.getElementById('max-energy-val').innerText = Math.floor(userBalance).toLocaleString();
                
                cleanPlaceholder.classList.add('hidden');
                cleanDashboard.classList.remove('hidden');
                
                // Trigger scan (Mock for now)
                renderCleanLists();
            } else {
                btn.innerText = "Connect Wallet";
                btn.classList.replace('glass', 'btn-primary');
                energyDisplay.classList.add('hidden');
                cleanPlaceholder.classList.remove('hidden');
                cleanDashboard.classList.add('hidden');
            }
        }

        function showToast(msg, type = "info") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `glass p-4 rounded-xl shadow-2xl border-l-4 transition-all duration-500 transform translate-x-full ${
                type === 'error' ? 'border-red-500' : 'border-blue-500'
            }`;
            toast.innerHTML = `<span class="text-sm font-bold">${msg}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function copyContract() {
            navigator.clipboard.writeText(SHITOUT_ADDRESS);
            showToast("Address copied!", "success");
        }

        // Mock Rendering for Lists
        function renderCleanLists() {
            const approved = document.getElementById('approved-list');
            const unknown = document.getElementById('unknown-list');
            
            // Mock data - в следующей итерации заменим на реальный fetch
            approved.innerHTML = `
                <div class="glass-card p-4 rounded-xl flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="w-5 h-5 rounded border-slate-700 bg-slate-900">
                        <div>
                            <div class="font-bold">PEPE (Classic)</div>
                            <div class="text-xs text-slate-500">Balance: 1,000,000</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-green-400">~$42.10</div>
                        <div class="text-[10px] text-slate-500">DexScreener Live</div>
                    </div>
                </div>
            `;

            unknown.innerHTML = `
                <div class="glass-card p-4 rounded-xl flex justify-between items-center opacity-70">
                    <div>
                        <div class="font-bold text-sm">UNKNOWN_SHIT_COIN</div>
                        <div class="text-[10px] text-slate-500 italic">No status in database</div>
                    </div>
                    <button class="px-4 py-1 rounded bg-blue-500/10 border border-blue-500/30 text-blue-400 text-xs font-bold hover:bg-blue-500/20">
                        Propose
                    </button>
                </div>
            `;
        }

        // Initialize state
        updateUI();
    </script>
</body>
</html>
