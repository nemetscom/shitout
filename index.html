<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHITOUT v1.0.2 — Dust Sweeper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; background: radial-gradient(circle at top right, #1e293b, #0f172a); color: #f1f5f9; min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(59, 130, 246, 0.2); transition: all 0.2s; }
        .glass-card:hover { border-color: rgba(59, 130, 246, 0.5); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-primary:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        .version-tag { position: fixed; bottom: 10px; left: 10px; font-size: 10px; color: #475569; z-index: 100; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="version-tag">v1.0.2 | Dashboard Active</div>

    <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="text-2xl font-bold">S</span>
            </div>
            <h1 class="text-3xl font-bold tracking-tighter text-blue-500">SHITOUT</h1>
        </div>

        <div class="flex items-center gap-4">
            <div id="energy-display" class="hidden glass px-4 py-2 rounded-xl flex items-center gap-3 border-blue-500/30">
                <span class="text-yellow-400">⚡</span>
                <span class="text-sm">Energy: <span id="energy-val" class="font-bold text-blue-400">0</span></span>
            </div>
            <button id="connect-btn" onclick="connectWallet()" class="btn-primary px-6 py-2 rounded-xl font-bold text-sm">
                Connect Wallet
            </button>
        </div>
    </header>

    <nav class="max-w-4xl mx-auto flex justify-around border-b border-slate-700 mb-8">
        <button onclick="switchTab('clean')" id="tab-btn-clean" class="tab-active py-4 px-6 font-bold uppercase text-xs">Clean</button>
        <button onclick="switchTab('gov')" id="tab-btn-gov" class="py-4 px-6 font-bold uppercase text-xs">Governance</button>
        <button onclick="switchTab('buy')" id="tab-btn-buy" class="py-4 px-6 font-bold uppercase text-xs">Buy</button>
    </nav>

    <main class="max-w-6xl mx-auto">
        
        <section id="tab-clean" class="tab-content">
            <div id="wallet-placeholder" class="text-center py-20 glass rounded-3xl border-dashed border-2 border-slate-700">
                <p class="text-slate-400">Connect wallet to start cleaning Base dust.</p>
            </div>

            <div id="clean-dashboard" class="hidden space-y-12">
                <div class="glass p-4 rounded-2xl border-blue-500/20 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span id="scan-status" class="text-xs font-bold text-slate-300 italic uppercase">Scanner Ready</span>
                    </div>
                    <div id="total-value" class="text-sm font-bold text-blue-400">Selected: $0.00</div>
                </div>

                <div id="approved-section">
                    <h2 class="text-xl font-bold mb-4 text-blue-400 flex items-center gap-2">
                        Ready to Clean <span class="text-[10px] bg-blue-500/20 px-2 py-0.5 rounded text-blue-300 uppercase">Approved</span>
                    </h2>
                    <div id="approved-list" class="grid gap-4"></div>
                    <button id="batch-swap-btn" disabled class="mt-6 w-full py-5 rounded-2xl bg-slate-800 border border-slate-700 text-slate-500 font-bold uppercase tracking-widest transition-all">
                        Swap Selected to USDC
                    </button>
                </div>

                <div id="unknown-section">
                    <h2 class="text-xl font-bold mb-4 text-slate-500 flex items-center gap-2">
                        Unidentified Assets <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-500 uppercase">Needs Vote</span>
                    </h2>
                    <div id="unknown-list" class="grid gap-4 opacity-70 hover:opacity-100 transition-opacity"></div>
                </div>
            </div>
        </section>

        <section id="tab-gov" class="tab-content hidden py-20 text-center text-slate-500 italic">Governance v1.0.2 - Redirecting logic...</section>
        <section id="tab-buy" class="tab-content hidden py-20 text-center text-slate-500 italic">Buy v1.0.2 - Price feed active...</section>
    </main>

    <div id="toast-container" class="fixed bottom-8 right-8 z-50 flex flex-col gap-2"></div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = "https://mfqteusxmwaagebykcdw.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mcXRldXN4bXdhYWdlYnlrY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODIyNDUsImV4cCI6MjA4NjE1ODI0NX0.x5NttkdL64UNu9toj-ud02Y0J_DYBojp--4FzTo9ULI";
        const SHITOUT_ADDR = "0xf37E99001AE478077B184bf448FE8174d928e5a4";

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let provider, signer, userAddr;
        let selectedTokens = new Map(); // addr -> usdValue

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function name() view returns (string)"
        ];

        // --- NAVIGATION ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('tab-btn-' + id).classList.add('tab-active');
        }

        // --- WALLET ---
        async function connectWallet() {
            if (!window.ethereum) return showToast("Install Metamask", "error");
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddr = accounts[0];
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                
                showToast("Connected: " + userAddr.slice(0,6), "success");
                updateUI();
                await scanUserDust();
            } catch (e) { showToast("Connection error", "error"); }
        }

        // --- SCANNER LOGIC v1.0.2 ---
        async function scanUserDust() {
            const approvedDiv = document.getElementById('approved-list');
            const unknownDiv = document.getElementById('unknown-list');
            const status = document.getElementById('scan-status');

            status.innerText = "Accessing Database...";
            approvedDiv.innerHTML = "";
            unknownDiv.innerHTML = "";

            try {
                const { data: dbTokens, error } = await sb.from('governance_tokens').select('*');
                if (error) throw error;

                status.innerText = `Scanning ${dbTokens.length} assets...`;

                for (const token of dbTokens) {
                    try {
                        const contract = new ethers.Contract(token.token_address, ERC20_ABI, provider);
                        const balanceRaw = await contract.balanceOf(userAddr);
                        const dec = await contract.decimals();
                        const balance = parseFloat(ethers.formatUnits(balanceRaw, dec));

                        if (balance > 0) {
                            // Получаем цену для расчета ценности
                            const priceInfo = await fetchPrice(token.token_address);
                            const usdVal = (balance * priceInfo.price).toFixed(2);
                            
                            const card = createTokenCard(token, balance, usdVal, priceInfo.price);
                            
                            if (token.status === 'approved') {
                                approvedDiv.innerHTML += card;
                            } else {
                                unknownDiv.innerHTML += card;
                            }
                        }
                    } catch (e) { console.warn("Skip:", token.symbol); }
                }
                status.innerText = "Scan Complete";
            } catch (e) { status.innerText = "Scan Error"; }
        }

        async function fetchPrice(addr) {
            try {
                const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${addr}`);
                const data = await res.json();
                if (data.pairs && data.pairs[0]) {
                    return { price: parseFloat(data.pairs[0].priceUsd || 0) };
                }
            } catch (e) {}
            return { price: 0 };
        }

        function createTokenCard(token, balance, usdVal, price) {
            const isApproved = token.status === 'approved';
            return `
                <div class="glass-card p-5 rounded-2xl flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        ${isApproved ? `<input type="checkbox" onchange="updateSelection('${token.token_address}', ${usdVal}, this.checked)" class="w-6 h-6 rounded border-slate-700 bg-slate-900 cursor-pointer">` : ''}
                        <div>
                            <div class="font-bold text-blue-400">${token.symbol} <span class="text-[10px] text-slate-500 font-normal ml-2">${token.name}</span></div>
                            <div class="text-xs text-slate-400">Balance: ${balance.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="text-right flex items-center gap-4">
                        <div>
                            <div class="font-bold text-white">$${usdVal}</div>
                            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">${token.status}</div>
                        </div>
                        ${!isApproved ? `<button onclick="proposeExisting('${token.token_address}')" class="px-3 py-1 bg-blue-500/10 border border-blue-500/30 text-blue-400 rounded-lg text-[10px] font-bold hover:bg-blue-500/20">PROPOSE</button>` : ''}
                    </div>
                </div>
            `;
        }

        // --- INTERACTION ---
        function updateSelection(addr, val, isChecked) {
            if (isChecked) selectedTokens.set(addr, val);
            else selectedTokens.delete(addr);

            let total = 0;
            selectedTokens.forEach(v => total += v);
            
            const btn = document.getElementById('batch-swap-btn');
            document.getElementById('total-value').innerText = `Selected: $${total.toFixed(2)}`;
            
            if (selectedTokens.size > 0) {
                btn.disabled = false;
                btn.classList.replace('bg-slate-800', 'btn-primary');
                btn.classList.replace('text-slate-500', 'text-white');
                btn.innerText = `Swap ${selectedTokens.size} Assets for USDC`;
            } else {
                btn.disabled = true;
                btn.classList.replace('btn-primary', 'bg-slate-800');
                btn.classList.replace('text-white', 'text-slate-500');
                btn.innerText = `Swap Selected to USDC`;
            }
        }

        async function proposeExisting(addr) {
            showToast("Opening Governance...", "info");
            switchTab('gov');
            // Здесь будет авто-заполнение поля адреса во второй вкладке
        }

        function updateUI() {
            document.getElementById('connect-btn').innerText = userAddr ? `${userAddr.slice(0,6)}...${userAddr.slice(-4)}` : "Connect Wallet";
            document.getElementById('wallet-placeholder').classList.toggle('hidden', !!userAddr);
            document.getElementById('clean-dashboard').classList.toggle('hidden', !userAddr);
            if (userAddr) document.getElementById('energy-display').classList.remove('hidden');
        }

        function showToast(m, type) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `glass p-4 rounded-xl border-l-4 ${type === 'error' ? 'border-red-500' : 'border-blue-500'} shadow-2xl`;
            t.innerHTML = `<span class="text-sm font-bold">${m}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        updateUI();
    </script>
</body>
</html>
