<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHITOUT — Dust Cleaner & Governance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        .pulse-energy { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="text-2xl font-bold">S</span>
            </div>
            <h1 class="text-3xl font-bold tracking-tighter text-blue-500">SHITOUT</h1>
        </div>

        <div class="flex items-center gap-4 flex-wrap justify-center">
            <div id="energy-display" class="hidden glass px-4 py-2 rounded-xl flex items-center gap-3">
                <span class="text-yellow-400 pulse-energy">⚡</span>
                <span class="text-sm">Energy: <span id="energy-val">0</span> / <span id="max-energy-val">0</span></span>
            </div>
            <button id="connect-btn" onclick="handleWalletAction()" class="btn-primary px-6 py-2 rounded-xl font-bold text-sm">
                Connect Wallet
            </button>
        </div>
    </header>

    <nav class="max-w-4xl mx-auto flex justify-around border-b border-slate-700 mb-8">
        <button onclick="switchTab('clean')" id="tab-btn-clean" class="tab-active py-4 px-6 font-bold uppercase text-xs">Clean</button>
        <button onclick="switchTab('gov')" id="tab-btn-gov" class="py-4 px-6 font-bold uppercase text-xs">Governance</button>
        <button onclick="switchTab('buy')" id="tab-btn-buy" class="py-4 px-6 font-bold uppercase text-xs">Buy $SHITOUT</button>
    </nav>

    <main class="max-w-6xl mx-auto">
        
        <section id="tab-clean" class="tab-content">
            <div id="wallet-placeholder" class="text-center py-20 glass rounded-3xl border-dashed border-2 border-slate-700">
                <p class="text-slate-400">Connect wallet to scan Base network for dust.</p>
            </div>
            <div id="clean-dashboard" class="hidden space-y-8">
                <div id="section-approved">
                    <h2 class="text-xl font-bold mb-4 text-blue-400">Ready to Clean</h2>
                    <div id="approved-list" class="grid gap-4"></div>
                    <button onclick="batchSwap()" class="mt-6 w-full py-4 rounded-2xl bg-green-600/20 border border-green-500/30 text-green-400 font-bold uppercase">
                        Batch Swap Selected to USDC
                    </button>
                </div>
                <div id="section-unknown">
                    <h2 class="text-xl font-bold mb-4 text-slate-400">Unidentified Assets</h2>
                    <div id="unknown-list" class="grid gap-4"></div>
                </div>
            </div>
        </section>

        <section id="tab-gov" class="tab-content hidden">
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="space-y-6">
                    <div class="glass p-6 rounded-2xl">
                        <h3 class="font-bold mb-4">New Proposal</h3>
                        <input id="token-address-input" type="text" placeholder="Token Address (0x...)" 
                               class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm mb-4 outline-none focus:border-blue-500">
                        <button onclick="proposeNewToken()" class="w-full btn-primary py-3 rounded-lg font-bold">
                            Propose (0.001 $SHITOUT)
                        </button>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-4" id="active-proposals">
                    <p class="text-center text-slate-500 py-10">Loading active proposals...</p>
                </div>
            </div>
        </section>

        <section id="tab-buy" class="tab-content hidden">
            <div class="max-w-2xl mx-auto glass-card p-8 rounded-3xl text-center">
                <h2 class="text-2xl font-bold mb-6 text-blue-400">Get Energy</h2>
                <div id="shitout-price" class="text-xl mb-6">Price: Fetching...</div>
                <a href="https://app.uniswap.org/#/swap?chain=base&outputCurrency=0xf37E99001AE478077B184bf448FE8174d928e5a4" target="_blank" 
                   class="btn-primary inline-block w-full py-4 rounded-2xl font-bold text-lg mb-4">
                    Buy $SHITOUT on Uniswap
                </a>
                <button onclick="copyContract()" class="text-xs text-slate-500">Copy Contract: 0xf37E...e5a4</button>
            </div>
        </section>
    </main>

    <div id="toast-container" class="fixed bottom-8 right-8 z-50 flex flex-col gap-2"></div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = "https://mfqteusxmwaagebykcdw.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mcXRldXN4bXdhYWdlYnlrY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODIyNDUsImV4cCI6MjA4NjE1ODI0NX0.x5NttkdL64UNu9toj-ud02Y0J_DYBojp--4FzTo9ULI"; 
        const SHITOUT_ADDR = "0xf37E99001AE478077B184bf448FE8174d928e5a4";
        const BASE_ID = "0x2105";

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let provider, signer, userAddr, energy = 0, balance = 0;

        // --- NAVIGATION ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('tab-btn-' + id).classList.add('tab-active');
            if(id === 'gov') loadProposals();
            if(id === 'buy') fetchShitoutPrice();
        }

        // --- WALLET ---
        async function handleWalletAction() {
            if (userAddr) { userAddr = null; updateUI(); return; }
            if (!window.ethereum) return showToast("Install Metamask", "error");

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const net = await provider.getNetwork();
                if (net.chainId !== 8453n) {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_ID }] });
                }
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddr = accounts[0];
                signer = await provider.getSigner();
                showToast("Wallet Connected", "success");
                await refreshData();
            } catch (e) { showToast(e.message, "error"); }
        }

        async function refreshData() {
            if (!userAddr) return;
            const abi = ["function balanceOf(address) view returns (uint256)"];
            const contract = new ethers.Contract(SHITOUT_ADDR, abi, provider);
            const b = await contract.balanceOf(userAddr);
            balance = parseFloat(ethers.formatEther(b));

            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            const { data: votes } = await sb.from('votes_log').select('amount').eq('user_address', userAddr).gte('created_at', sevenDaysAgo);
            const spent = votes ? votes.reduce((sum, v) => sum + parseFloat(v.amount), 0) : 0;
            
            energy = Math.max(0, balance - spent);
            updateUI();
        }

        function updateUI() {
            const btn = document.getElementById('connect-btn');
            const enDisp = document.getElementById('energy-display');
            btn.innerText = userAddr ? `${userAddr.slice(0,6)}...${userAddr.slice(-4)}` : "Connect Wallet";
            enDisp.classList.toggle('hidden', !userAddr);
            document.getElementById('energy-val').innerText = Math.floor(energy);
            document.getElementById('max-energy-val').innerText = Math.floor(balance);
            document.getElementById('wallet-placeholder').classList.toggle('hidden', !!userAddr);
            document.getElementById('clean-dashboard').classList.toggle('hidden', !userAddr);
        }

        // --- GOVERNANCE LOGIC ---
        async function proposeNewToken() {
            const addr = document.getElementById('token-address-input').value.trim();
            if (!ethers.isAddress(addr)) return showToast("Invalid Address", "error");

            // 1. Check DB
            const { data: existing } = await sb.from('governance_tokens').select('id').eq('token_address', addr).single();
            if (existing) return showToast("Already in list", "error");

            // 2. Fetch DexScreener
            showToast("Fetching token data...", "info");
            try {
                const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${addr}`);
                const data = await res.json();
                if (!data.pairs) throw new Error("Token not found on DEX");
                
                const token = data.pairs[0].baseToken;
                // 3. Insert to DB
                const { error } = await sb.from('governance_tokens').insert([
                    { token_address: addr, symbol: token.symbol, name: token.name, total_votes: 0, status: 'pending' }
                ]);
                
                if (error) throw error;
                showToast("Proposed! Waiting for deploy payment.", "success");
                loadProposals();
            } catch (e) { showToast(e.message, "error"); }
        }

        async function loadProposals() {
            const container = document.getElementById('active-proposals');
            const { data: tokens } = await sb.from('governance_tokens').select('*').eq('status', 'pending');
            
            if (!tokens || tokens.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-10">No active proposals</p>`;
                return;
            }

            container.innerHTML = tokens.map(t => `
                <div class="glass-card p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="font-bold">${t.symbol}</div>
                        <div class="text-xs text-slate-500">${t.name}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="text-sm font-bold text-blue-400">${t.total_votes} votes</div>
                        </div>
                        <button onclick="vote('${t.id}', 100)" class="px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg text-xs font-bold">UP</button>
                    </div>
                </div>
            `).join('');
        }

        // --- UTILS ---
        function showToast(m, type) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `glass p-4 rounded-xl border-l-4 ${type === 'error' ? 'border-red-500' : 'border-blue-500'} transition-all`;
            t.innerHTML = `<span class="text-sm font-bold">${m}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        async function fetchShitoutPrice() {
            try {
                const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${SHITOUT_ADDR}`);
                const data = await res.json();
                if (data.pairs) {
                    document.getElementById('shitout-price').innerText = `Price: $${data.pairs[0].priceUsd}`;
                }
            } catch (e) {}
        }

        function copyContract() {
            navigator.clipboard.writeText(SHITOUT_ADDR);
            showToast("Address Copied", "success");
        }

        updateUI();
    </script>
</body>
</html>
