<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHITOUT — Dust Cleaner & Governance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; background: radial-gradient(circle at top right, #1e293b, #0f172a); color: #f1f5f9; min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(59, 130, 246, 0.2); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); transition: all 0.2s ease; }
        .btn-primary:active { transform: scale(0.98); }
        .pulse-energy { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .loader { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="text-2xl font-bold">S</span>
            </div>
            <h1 class="text-3xl font-bold tracking-tighter text-blue-500">SHITOUT</h1>
        </div>

        <div class="flex items-center gap-4 flex-wrap justify-center">
            <div id="energy-display" class="hidden glass px-4 py-2 rounded-xl flex items-center gap-3">
                <span class="text-yellow-400 pulse-energy">⚡</span>
                <span class="text-sm">Energy: <span id="energy-val">0</span> / <span id="max-energy-val">0</span></span>
            </div>
            <button id="connect-btn" onclick="connectWallet()" class="btn-primary px-6 py-2 rounded-xl font-bold text-sm">
                Connect Wallet
            </button>
        </div>
    </header>

    <nav class="max-w-4xl mx-auto flex justify-around border-b border-slate-700 mb-8">
        <button onclick="switchTab('clean')" id="tab-btn-clean" class="tab-active py-4 px-6 font-bold uppercase text-xs">Clean</button>
        <button onclick="switchTab('gov')" id="tab-btn-gov" class="py-4 px-6 font-bold uppercase text-xs">Governance</button>
        <button onclick="switchTab('buy')" id="tab-btn-buy" class="py-4 px-6 font-bold uppercase text-xs">Buy $SHITOUT</button>
    </nav>

    <main class="max-w-6xl mx-auto">
        
        <section id="tab-clean" class="tab-content">
            <div id="wallet-placeholder" class="text-center py-20 glass rounded-3xl border-dashed border-2 border-slate-700">
                <p class="text-slate-400 mb-4">Connect wallet to scan for your dust on Base network.</p>
                <button onclick="connectWallet()" class="btn-primary px-8 py-3 rounded-xl font-bold">Connect Wallet</button>
            </div>

            <div id="clean-dashboard" class="hidden space-y-12">
                <div>
                    <div class="flex justify-between items-end mb-4">
                        <h2 class="text-xl font-bold text-blue-400">Approved for Cleaning</h2>
                        <span id="scan-status" class="text-[10px] text-slate-500 italic"></span>
                    </div>
                    <div id="approved-list" class="grid gap-4">
                        </div>
                    <button id="batch-swap-btn" disabled class="mt-6 w-full py-4 rounded-2xl bg-slate-800 border border-slate-700 text-slate-500 font-bold uppercase transition-all">
                        Batch Swap (Select Tokens)
                    </button>
                </div>

                <div>
                    <h2 class="text-xl font-bold mb-4 text-slate-400">Other Dust Found</h2>
                    <div id="unknown-list" class="grid gap-4 opacity-60">
                        </div>
                </div>
            </div>
        </section>

        <section id="tab-gov" class="tab-content hidden text-center py-20">
            <p class="text-slate-500">Governance loading...</p>
        </section>

        <section id="tab-buy" class="tab-content hidden text-center py-20">
             <p class="text-slate-500">Buy section loading...</p>
        </section>
    </main>

    <div id="toast-container" class="fixed bottom-8 right-8 z-50 flex flex-col gap-2"></div>

    <script>
        const SUPABASE_URL = "https://mfqteusxmwaagebykcdw.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mcXRldXN4bXdhYWdlYnlrY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODIyNDUsImV4cCI6MjA4NjE1ODI0NX0.x5NttkdL64UNu9toj-ud02Y0J_DYBojp--4FzTo9ULI"; 
        const SHITOUT_ADDR = "0xf37E99001AE478077B184bf448FE8174d928e5a4";
        const BASE_ID = "0x2105";

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let provider, signer, userAddr, energy = 0, balance = 0;
        let tokensToSwap = new Set();

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function name() view returns (string)"
        ];

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('tab-btn-' + id).classList.add('tab-active');
            if(id === 'clean' && userAddr) scanUserDust();
        }

        async function connectWallet() {
            if (!window.ethereum) return showToast("Install Metamask", "error");
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddr = accounts[0];
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                
                showToast("Wallet Connected", "success");
                await refreshData();
                updateUI();
                scanUserDust(); // Запуск сканирования
            } catch (e) { showToast("Connection failed", "error"); }
        }

        async function refreshData() {
            if (!userAddr) return;
            const contract = new ethers.Contract(SHITOUT_ADDR, ERC20_ABI, provider);
            const b = await contract.balanceOf(userAddr);
            balance = parseFloat(ethers.formatEther(b));
            energy = balance; // Упрощенный расчет для теста
        }

        function updateUI() {
            const btn = document.getElementById('connect-btn');
            const enDisp = document.getElementById('energy-display');
            btn.innerText = userAddr ? `${userAddr.slice(0,6)}...${userAddr.slice(-4)}` : "Connect Wallet";
            enDisp.classList.toggle('hidden', !userAddr);
            document.getElementById('energy-val').innerText = Math.floor(energy).toLocaleString();
            document.getElementById('max-energy-val').innerText = Math.floor(balance).toLocaleString();
            document.getElementById('wallet-placeholder').classList.toggle('hidden', !!userAddr);
            document.getElementById('clean-dashboard').classList.toggle('hidden', !userAddr);
        }

        // --- ГЛАВНАЯ ЛОГИКА: СКАНИРОВАНИЕ ПЫЛИ ---
        async function scanUserDust() {
            const approvedList = document.getElementById('approved-list');
            const unknownList = document.getElementById('unknown-list');
            const status = document.getElementById('scan-status');
            
            status.innerText = "Scanning Base Network...";
            approvedList.innerHTML = `<div class="p-8 text-center text-slate-600 italic">Searching for approved dust...</div>`;
            unknownList.innerHTML = "";

            try {
                // 1. Получаем все токены из нашей БД
                const { data: dbTokens, error } = await sb.from('governance_tokens').select('*');
                if (error) throw error;

                let foundApproved = 0;
                approvedList.innerHTML = "";

                for (const token of dbTokens) {
                    const contract = new ethers.Contract(token.token_address, ERC20_ABI, provider);
                    try {
                        const balRaw = await contract.balanceOf(userAddr);
                        const decimals = await contract.decimals();
                        const balFormatted = parseFloat(ethers.formatUnits(balRaw, decimals));

                        if (balFormatted > 0) {
                            // Токен есть на кошельке! Тянем цену из DexScreener
                            const priceData = await fetchTokenPrice(token.token_address);
                            const usdValue = (balFormatted * priceData.price).toFixed(2);

                            const cardHtml = createTokenCard(token, balFormatted, usdValue, priceData.change);
                            
                            if (token.status === 'approved') {
                                approvedList.innerHTML += cardHtml;
                                foundApproved++;
                            } else {
                                unknownList.innerHTML += cardHtml;
                            }
                        }
                    } catch (e) { console.error("Error scanning token:", token.symbol); }
                }

                if (foundApproved === 0) {
                    approvedList.innerHTML = `<div class="p-8 text-center text-slate-600 italic">No approved dust tokens found on your wallet.</div>`;
                }
                status.innerText = "Scan complete";

            } catch (err) {
                showToast("Scan failed", "error");
                console.error(err);
            }
        }

        async function fetchTokenPrice(addr) {
            try {
                const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${addr}`);
                const data = await res.json();
                if (data.pairs && data.pairs[0]) {
                    return { 
                        price: parseFloat(data.pairs[0].priceUsd || 0), 
                        change: data.pairs[0].priceChange.h24 || 0 
                    };
                }
            } catch (e) {}
            return { price: 0, change: 0 };
        }

        function createTokenCard(token, balance, usd, change) {
            const isApproved = token.status === 'approved';
            return `
                <div class="glass-card p-5 rounded-2xl flex justify-between items-center group">
                    <div class="flex items-center gap-4">
                        ${isApproved ? `<input type="checkbox" onchange="toggleSelect('${token.token_address}')" class="w-6 h-6 rounded-lg border-slate-700 bg-slate-900 checked:bg-blue-500 transition-all cursor-pointer">` : ''}
                        <div>
                            <div class="font-bold text-lg flex items-center gap-2">
                                ${token.symbol} 
                                <span class="text-[10px] px-2 py-0.5 rounded bg-slate-800 text-slate-500 font-normal">${token.name}</span>
                            </div>
                            <div class="text-xs text-slate-400">Balance: ${balance.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-400">$${usd}</div>
                        <div class="text-[10px] ${change >= 0 ? 'text-green-500' : 'text-red-500'}">${change > 0 ? '+' : ''}${change}% (24h)</div>
                    </div>
                </div>
            `;
        }

        function toggleSelect(addr) {
            if (tokensToSwap.has(addr)) tokensToSwap.delete(addr);
            else tokensToSwap.add(addr);

            const btn = document.getElementById('batch-swap-btn');
            if (tokensToSwap.size > 0) {
                btn.disabled = false;
                btn.classList.replace('bg-slate-800', 'btn-primary');
                btn.classList.replace('text-slate-500', 'text-white');
                btn.innerText = `Batch Swap (${tokensToSwap.size} Tokens)`;
            } else {
                btn.disabled = true;
                btn.classList.replace('btn-primary', 'bg-slate-800');
                btn.classList.replace('text-white', 'text-slate-500');
                btn.innerText = `Batch Swap (Select Tokens)`;
            }
        }

        function showToast(m, type) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `glass p-4 rounded-xl border-l-4 ${type === 'error' ? 'border-red-500' : 'border-blue-500'} shadow-2xl transition-all`;
            t.innerHTML = `<span class="text-sm font-bold">${m}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        updateUI();
    </script>
</body>
</html>
